# https://circleci.com/docs/configuration#machine
machine:
  php:
    # https://circleci.com/docs/environment#php
    version: 5.5.11
  pre:
    # @todo look for a better way to install phantomjs.
    - sudo curl --output /usr/local/bin/phantomjs https://s3.amazonaws.com/circle-downloads/phantomjs-2.1.1

dependencies:
  pre:
    - npm install -g sitespeed.io

  cache_directories:
    - ~/.composer/cache

  post:
    # Build the static site.
    - bin/sculpin generate
    - cd output_dev && ln -s ./ source
    # Deploy Multidev environment
    # uncomment this line once the PR is made to pantheon-systems/documentation
    #- bash scripts/deploy-multidev.sh
test:
  pre:
    # Start Ghost Driver.
    - phantomjs --webdriver=8643:
       background: true
    # Start Sculpin.
    - bin/sculpin server:
       background: true
  override:
    # Run behat.
    - bin/behat
    # Run a11y.
    - grunt
    # Look for merge conflicts.
    - scripts/merge_conflicts.sh
    # Run htmlproofer.
    - bundle exec rake
    # @todo, Switch the test to http://"$normalize_branch"-static-docs.pantheon.io
    # also this line may have to be moved to a place where normalize_branch
    # can be constructed.
    # @todo, revisit contents of the  budget file. It copied from the
    # sitespeed.io repo with little change.
    - sitespeed.io -u http://localhost:8000/docs   --budget budget.json -b firefox  --skipTest=ycookiefree,avoidfont -r $CIRCLE_ARTIFACTS/sitespeed --suppressDomainFolder --outputFolderName test

deployment:
  production:
    branch: master
    commands:
      - bash scripts/deploy-live.sh
